name: ğŸš€ CI/CD Pipeline

# DÃ©clencheur : Ã  chaque push sur main
on:
  push:
    branches: [ main ]

jobs:
  # Job 1 : Tests automatiques
  tests:
    name: ğŸ§ª Tests PHPUnit
    runs-on: ubuntu-latest

    steps:
      # RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # Installer PHP 8.2
      - name: ğŸ˜ Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      # Installer les dÃ©pendances
      - name: ğŸ“¦ Install dependencies
        run: composer install

      # Lancer les tests
      - name: ğŸ§ª Run tests
        run: vendor/bin/phpunit

  # Job 2 : Build et DÃ©ploiement (seulement si tests OK)
  build-and-deploy:
    name: ğŸ³ Build & Deploy
    runs-on: ubuntu-latest
    needs: tests  # Attend que les tests passent
    if: github.ref == 'refs/heads/main'

    steps:
      # RÃ©cupÃ©rer le code
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      # Se connecter Ã  Docker Hub
      - name: ğŸ” Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Construire et pousser l'image
      - name: ğŸ—ï¸ Build and Push
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/calculatrice-app:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/calculatrice-app:latest

      # Message de succÃ¨s
      - name: ğŸ‰ Success
        run: |
          echo "âœ… DÃ©ploiement simplifiÃ© rÃ©ussi !"
          echo "ğŸ“¦ Image: ${{ secrets.DOCKER_USERNAME }}/calculatrice-app:latest"